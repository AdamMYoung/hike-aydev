{"version":3,"sources":["../index.ts","../libs/prisma.ts","../libs/routes.ts","../libs/kv.ts","../libs/requests.ts","../libs/user.ts","../routes/activities/activities.ts"],"sourcesContent":["// ESM\nimport * as dotenv from \"dotenv\";\ndotenv.config();\n\nimport Fastify from \"fastify\";\nimport { routes as activities } from \"./routes/activities\";\n\nconst fastify = Fastify({\n  logger: true,\n});\n\n// Health check endpoint\nfastify.get(\"/health\", (req, reply) => {\n  reply.status(200).send();\n});\n\n// Application routes\nfastify.register((instance, opts, done) => {\n  instance.addHook(\"preHandler\", (req, reply, done) => {\n    if (req)\n      if (req.headers[\"x-api-key\"] === process.env.GEOSPATIAL_API_KEY) {\n        done();\n        return;\n      }\n\n    reply.status(401).send();\n  });\n\n  instance.register(activities);\n  done();\n});\n\n/**\n * Run the server!\n */\nconst start = async () => {\n  try {\n    await fastify.listen({ port: 4000, host: \"0.0.0.0\" });\n  } catch (err) {\n    fastify.log.error(err);\n    process.exit(1);\n  }\n};\n\nstart();\n","import { PrismaClient } from \"database\";\n\nexport const prisma = new PrismaClient();\n","import { decode } from \"@googlemaps/polyline-codec\";\nimport circle from \"@turf/circle\";\nimport { lineString } from \"@turf/helpers\";\nimport lineIntersect from \"@turf/line-intersect\";\nimport { getFellPoints } from \"./requests\";\n\nexport const getFellsOnPolyline = async (polyline: string) => {\n  const decodedPolyline = decode(polyline);\n  const points = await getFellPoints();\n\n  const line = lineString(decodedPolyline);\n  const circles = points.map((c) => circle([c.lat, c.lng], 0.1, { properties: { id: c.id, name: c.name } }));\n\n  const intersectingCircles = circles.filter((c) => lineIntersect(c, line).features.length > 0);\n  const intersectingIds = intersectingCircles.map((c) => c.properties.id);\n\n  return points.filter((p) => intersectingIds.includes(p.id));\n};\n","import kv from \"@vercel/kv\";\n\nexport const getCachedEntry = async <T extends unknown>(key: string, req: () => Promise<T>) => {\n  if (process.env.VERCEL_ENV !== \"production\") {\n    return req();\n  }\n\n  const stored = await kv.get<T>(key);\n\n  if (stored) {\n    return stored;\n  }\n\n  const request = await req();\n  await kv.set(key, request, { ex: 3600 });\n\n  return request;\n};\n","import { prisma } from \"./prisma\";\nimport { getCachedEntry } from \"./kv\";\n\nexport const getFellPoints = () => {\n  return getCachedEntry(\"get-fell-points\", () =>\n    prisma.fell.findMany({\n      select: {\n        id: true,\n        lat: true,\n        lng: true,\n        name: true,\n      },\n    })\n  );\n};\n","import { prisma } from \"./prisma\";\n\nexport const getUserByStravaId = async (stravaId: string) => {\n  return prisma.account.findUnique({\n    where: {\n      provider_providerAccountId: {\n        providerAccountId: stravaId,\n        provider: \"strava\",\n      },\n    },\n    select: {\n      access_token: true,\n      user: {\n        select: {\n          id: true,\n          name: true,\n        },\n      },\n    },\n  });\n};\n","import { FastifyInstance, RouteShorthandOptions } from \"fastify\";\n\nimport { prisma } from \"../../libs/prisma\";\nimport { getFellsOnPolyline } from \"../../libs/routes\";\nimport { getUserByStravaId } from \"../../libs/user\";\n\nconst stravaOpts: RouteShorthandOptions = {\n  schema: {\n    body: {\n      type: \"object\",\n      properties: {\n        polyline: { type: \"string\" },\n        ownerId: { type: \"string\" },\n      },\n    },\n  },\n};\n\nexport async function routes(fastify: FastifyInstance, options: object) {\n  fastify.post(\"/activities/manual\", async (request, reply) => {\n    return { hello: \"world\" };\n  });\n\n  fastify.post(\"/activities/strava\", stravaOpts, async (request, reply) => {\n    const { polyline, ownerId } = request.body as { polyline: string; ownerId: string };\n\n    const stravaAccount = await getUserByStravaId(ownerId);\n\n    if (!stravaAccount) {\n      reply.status(401).send();\n      return;\n    }\n\n    const fellsOnPolyline = await getFellsOnPolyline(polyline);\n\n    await prisma.logEntry.createMany({\n      skipDuplicates: true,\n      data: fellsOnPolyline.map((fell) => ({\n        fellId: fell.id,\n        authorId: stravaAccount.user.id,\n        climbed: true,\n      })),\n    });\n\n    reply.send();\n  });\n}\n"],"mappings":"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","names":["kv","circle","lineIntersect","fastify","Fastify","done"]}